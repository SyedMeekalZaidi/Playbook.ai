generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Playbook {
  id               String                 @id @default(uuid())
  name             String
  shortDescription String?                @db.VarChar(280)
  documentContent  Json?
  ownerId          String                 // Supabase Auth user ID
  isDeleted        Boolean                @default(false)
  deletedAt        DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  collaborators    PlaybookCollaborator[]
  processes        Process[]
  versionHistories VersionHistory[]
  images           DocumentImage[]
  sessions         CollaborationSession[] 
  changeLogs       ChangeLog[]            
}

model PlaybookCollaborator {
  id         String   @id @default(uuid())
  playbookId String
  userId     String   // Supabase Auth user ID
  role       Role     @default(ADMIN)
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model Process {
  id               String        @id @default(uuid())
  name             String
  shortDescription String?       @db.VarChar(280)
  documentContent  Json?
  playbookId       String
  parentId         String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  playbook         Playbook      @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  nodes            Node[]        
  images           DocumentImage[] 
  // Adding self-relation for parent-child processes if needed
  parentProcess    Process?      @relation("ProcessToProcess", fields: [parentId], references: [id])
  subProcesses     Process[]     @relation("ProcessToProcess")
}

model Node {
  id               String          @id @default(uuid())
  name             String
  shortDescription String?         @db.VarChar(280)
  documentContent  Json?
  type             String?
  bpmnId           String?
  processId        String
  process          Process         @relation(fields: [processId], references: [id], onDelete: Cascade)
  parameters       NodeParameter[]
  lockedById       String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  images           DocumentImage[]
}

model NodeParameter {
  id        String   @id @default(uuid())
  name      String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  nodeId    String
  type      String
  mandatory Boolean
  options   String[]
}

model CollaborationSession {
  id         String    @id @default(uuid())
  playbookId String
  userId     String    // Supabase Auth user ID
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  playbook   Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model ChangeLog {
  id         String   @id @default(uuid())
  playbookId String
  userId     String   // Supabase Auth user ID
  action     String
  details    String?
  timestamp  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model VersionHistory {
  id         String   @id @default(uuid())
  playbookId String
  version    Int
  data       Json
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model DocumentImage {
  id         String   @id @default(uuid())
  url        String
  alt        String?
  caption    String?
  playbookId String?
  playbook   Playbook? @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  processId  String?
  process    Process?  @relation(fields: [processId], references: [id], onDelete: Cascade)
  nodeId     String?
  node       Node?     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum Role {
  ADMIN
  PLAYBOOK_CREATOR
  COLLABORATOR
}
