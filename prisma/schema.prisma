generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Audit trail of every minor change
model ChangeLog {
  id         String   @id
  playbookId String
  userId     String
  action     String
  details    String?
  timestamp  DateTime @default(now())
  Playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

// A snapshot of the playbook that can be reverted back to
model VersionHistory {
  id         String   @id
  playbookId String
  version    Int
  data       Json
  createdAt  DateTime @default(now())
  Playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model CollaborationSession {
  id         String    @id
  playbookId String
  userId     String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  Playbook   Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model DocumentImage {
  id         String    @id
  url        String
  alt        String?
  caption    String?
  playbookId String?
  processId  String?
  nodeId     String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Node       Node?     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  Playbook   Playbook? @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  Process    Process?  @relation(fields: [processId], references: [id], onDelete: Cascade)
}

model Node {
  id               String             @id
  name             String
  type             String?
  processId        String
  lockedById       String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  documentContent  Json?
  shortDescription String?            @db.VarChar(280)
  bpmnId           String?
  DocumentImage    DocumentImage[]
  Process          Process            @relation(fields: [processId], references: [id], onDelete: Cascade)
  ProcessParameter ProcessParameter[]

  @@unique([bpmnId, processId]) // Ensure uniqueness of BPMN node per process
}

model Playbook {
  id                   String                 @id
  name                 String
  ownerId              String // This is a String, not directly related to a User model here
  isDeleted            Boolean                @default(false)
  deletedAt            DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  documentContent      Json?
  shortDescription     String?                @db.VarChar(280)
  status               Status                 @default(PLANNING)
  sourcePlaybookId     String?                // ID of the playbook this was copied from
  sourcePlaybook       Playbook?              @relation("PlaybookCopies", fields: [sourcePlaybookId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  copiedToPlaybooks    Playbook[]             @relation("PlaybookCopies") // List of playbooks that are copies of this one
  ChangeLog            ChangeLog[]
  CollaborationSession CollaborationSession[]
  DocumentImage        DocumentImage[]
  Event                Event[]
  PlaybookCollaborator PlaybookCollaborator[]
  Process              Process[]
  VersionHistory       VersionHistory[]
  PlaybookShareLogOriginal PlaybookShareLog[] @relation("OriginalPlaybookShares")
  PlaybookShareLogCopied   PlaybookShareLog[] @relation("CopiedPlaybookShares")
}

model PlaybookCollaborator {
  id         String   @id
  playbookId String
  userId     String // Stores Supabase User ID as a String
  role       Role     @default(ADMIN)
  createdAt  DateTime @default(now())
  Playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  @@unique([playbookId, userId]) // Added unique constraint
}

model Process {
  id                                                           String              @id
  name                                                         String
  playbookId                                                   String
  createdAt                                                    DateTime            @default(now())
  updatedAt                                                    DateTime
  documentContent                                              Json?
  shortDescription                                             String?             @db.VarChar(280)
  bpmnId                                                       String?
  bpmnXml                                                      String?
  parentId                                                     String?
  DocumentImage                                                DocumentImage[]
  Event                                                        Event[]
  Node                                                         Node[]
  Playbook                                                     Playbook            @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  ProcessDependency_ProcessDependency_parentProcessIdToProcess ProcessDependency[] @relation("ProcessDependency_parentProcessIdToProcess")
  ProcessDependency_ProcessDependency_processIdToProcess       ProcessDependency[] @relation("ProcessDependency_processIdToProcess")
  ProcessParameter                                             ProcessParameter[]
}

model ProcessDependency {
  id                                                 String  @id
  parentProcessId                                    String
  processId                                          String
  trigger                                            String?
  Process_ProcessDependency_parentProcessIdToProcess Process @relation("ProcessDependency_parentProcessIdToProcess", fields: [parentProcessId], references: [id])
  Process_ProcessDependency_processIdToProcess       Process @relation("ProcessDependency_processIdToProcess", fields: [processId], references: [id])

  @@unique([parentProcessId, processId])
}

model ProcessParameter {
  id        String   @id
  name      String
  processId String?
  nodeId    String?
  type      String
  mandatory Boolean
  options   String[]
  Node      Node?    @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  Process   Process? @relation(fields: [processId], references: [id], onDelete: Cascade)
}

model Event {
  id               String   @id @default(uuid())
  name             String
  description      String?
  playbookId       String
  ownerId          String
  parameters       String[]
  status           Status?  @default(PLANNING)
  currentProcessId String
  currentProcess   Process  @relation(fields: [currentProcessId], references: [id])
  Playbook         Playbook @relation(fields: [playbookId], references: [id])
}

model PlaybookShareLog {
  id                 String   @id @default(uuid())
  originalPlaybookId String
  copiedPlaybookId   String   @unique // Each copy event results in one unique copied playbook
  sharedByUserId     String   // User ID of the person who initiated the share
  sharedWithUserId   String   // User ID of the person who received the copy (new owner)
  sharedAt           DateTime @default(now())

  originalPlaybook Playbook @relation("OriginalPlaybookShares", fields: [originalPlaybookId], references: [id], onDelete: Cascade)
  copiedPlaybook   Playbook @relation("CopiedPlaybookShares", fields: [copiedPlaybookId], references: [id], onDelete: Cascade)

  @@index([originalPlaybookId])
  @@index([sharedByUserId])
  @@index([sharedWithUserId])
}

enum Role {
  ADMIN
  COLLABORATOR
}

enum Status {
  PENDING
  PLANNING
  ON_GOING
  COMPLETE
  CANCELLED
  PUBLISHED
}
