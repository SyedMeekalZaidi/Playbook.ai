generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model User {
  id             String                 @id @default(uuid())
  email          String                 @unique
  name           String?
  role           Role
  password       String
  changeLogs     ChangeLog[]
  sessions       CollaborationSession[]
  lockedNodes    Node[]
  playbooks      Playbook[]
  collaborations PlaybookCollaborator[]
}

model Playbook {
  id               String                 @id @default(uuid())
  name             String
  description      String?
  ownerId          String
  isDeleted        Boolean                @default(false)
  deletedAt        DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  changeLogs       ChangeLog[]
  sessions         CollaborationSession[]
  owner            User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  collaborators    PlaybookCollaborator[]
  processes        Process[]
  versionHistories VersionHistory[]
}

model PlaybookCollaborator {
  id         String   @id @default(uuid())
  playbookId String
  userId     String
  role       Role     @default(ADMIN)
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Process {
  id            String    @id @default(uuid())
  name          String
  description   String?
  playbook      Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  playbookId    String
  nodes         Node[]
  bpmnId        String?
  bpmnXml       String?
  parentId      String?
  parentProcess Process?  @relation("ProcessToProcess", fields: [parentId], references: [id])
  subProcesses  Process[] @relation("ProcessToProcess")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Node {
  id          String          @id @default(uuid())
  name        String
  description String?
  type        String //bpmn node type
  processId   String?
  process     Process?        @relation(fields: [processId], references: [id], onDelete: Cascade)
  parameters  NodeParameter[]
  lockedById  String?
  lockedBy    User?           @relation(fields: [lockedById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model NodeParameter {
  id        String   @id @default(uuid())
  name      String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  nodeId    String
  type      String? //option type
  mandatory Boolean
  options   String[]
}

model CollaborationSession {
  id         String    @id @default(uuid())
  playbookId String
  userId     String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  playbook   Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChangeLog {
  id         String   @id @default(uuid())
  playbookId String
  userId     String
  action     String
  details    String?
  timestamp  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VersionHistory {
  id         String   @id @default(uuid())
  playbookId String
  version    Int
  data       Json
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  PLAYBOOK_CREATOR
  COLLABORATOR
  USER
}
