generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Playbook {
  id                  String                 @id @default(uuid())
  name                String
  ownerId             String
  isDeleted           Boolean                @default(false)
  deletedAt           DateTime?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  documentContent     Json?
  shortDescription    String?                @db.VarChar(280)
  changeLogs          ChangeLog[]
  sessions            CollaborationSession[]
  images              DocumentImage[]
  collaborators       PlaybookCollaborator[]
  processes           Process[]
  versionHistories    VersionHistory[]
  processDependencies ProcessDependency[]
}

model PlaybookCollaborator {
  id         String   @id @default(uuid())
  playbookId String
  userId     String
  role       Role     @default(ADMIN)
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model Process {
  id               String              @id @default(uuid())
  name             String
  playbookId       String
  parentId         String?
  documentContent  Json?
  shortDescription String?             @db.VarChar(280)
  parentProcess    Process?            @relation("ProcessToProcess", fields: [parentId], references: [id])
  subProcesses     Process[]           @relation("ProcessToProcess")
  nodes            Node[]
  fromProcess      ProcessDependency[] @relation("FromProcess")
  toProcess        ProcessDependency[] @relation("ToProcess")
  images           DocumentImage[]
  playbook         Playbook            @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model ProcessDependency {
  id         String   @id @default(uuid())
  fromId     String
  toId       String
  playbookId String
  playbook   Playbook @relation(fields: [playbookId], references: [id])

  fromProcess Process @relation("FromProcess", fields: [fromId], references: [id])
  toProcess   Process @relation("ToProcess", fields: [toId], references: [id])

  trigger String

  @@unique([fromId, toId])
}

model Node {
  id               String          @id @default(uuid())
  name             String
  type             String?
  processId        String
  lockedById       String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  documentContent  Json?
  shortDescription String?         @db.VarChar(280)
  bpmnId           String?
  images           DocumentImage[]
  process          Process         @relation(fields: [processId], references: [id], onDelete: Cascade)
  parameters       NodeParameter[]
}

model NodeParameter {
  id        String   @id @default(uuid())
  name      String
  nodeId    String
  type      String
  mandatory Boolean
  options   String[]
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
}

model CollaborationSession {
  id         String    @id @default(uuid())
  playbookId String
  userId     String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  playbook   Playbook  @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model ChangeLog {
  id         String   @id @default(uuid())
  playbookId String
  userId     String
  action     String
  details    String?
  timestamp  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model VersionHistory {
  id         String   @id @default(uuid())
  playbookId String
  version    Int
  data       Json
  createdAt  DateTime @default(now())
  playbook   Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
}

model DocumentImage {
  id         String    @id @default(uuid())
  url        String
  alt        String?
  caption    String?
  playbookId String?
  processId  String?
  nodeId     String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  node       Node?     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  playbook   Playbook? @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  process    Process?  @relation(fields: [processId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  PLAYBOOK_CREATOR
  COLLABORATOR
}
